---
title: "Análise preditiva da expectativa de vida no Brasil"
author: "Maurício Collaça Ramos"
date: "12 de Julho de 2018"
output: 
  html_document: 
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float:
        collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "")
options(width = 130)
t0<-proc.time()
```

# Recursos computacionais

Sistema Operacional:
```{r}
paste(Sys.info()[1:3], collapse = " ")
```

Processadores:
```{r}
parallel::detectCores()
```

Memória:
```{r}
if(Sys.info()[1]=="Windows") paste(round(memory.limit()/1024,1),"Gb") else cat(system("free -h", intern = TRUE), sep='\n')
```

Linguagem:
```{r}
R.version.string
```

Pacotes R:
```{r}
packages <- c("ggplot2", "gridExtra", "GGally", "dplyr", "tidyr", "caret", "parallel", "doParallel", "randomForest")
loaded <- suppressWarnings(sapply(packages, require, character.only=TRUE, warn.conflicts=FALSE, quietly=TRUE))
if(!all(loaded)) {
    missingPackages <- packages[loaded==FALSE]
    message("Installing package(s) ", paste(missingPackages, collapse=", "))
    install.packages(missingPackages, dependencies = TRUE)
    installed <- suppressWarnings(sapply(missingPackages, require, character.only=TRUE, warn.conflicts=FALSE, quietly=TRUE))
    if(!all(installed)) stop("Package(s) not installed: ", paste(missingPackages[installed==FALSE], collapse=", "))
    
}
packageVersions <- sapply(packages, function(x) paste0(as.character(packageVersion(x)), collapse="."))
noquote(packageVersions)
```

# Carga dos dados brutos do atlas municipal

```{r}
dicionario <- read.csv2("dicionario.csv", encoding = "UTF-8")
names(dicionario) <- toupper(iconv(names(dicionario), to="ASCII//TRANSLIT"))
data <- read.csv2("municipal.csv", encoding = "UTF-8",
                       colClasses=c(rep("factor",2),rep("character",3),rep("numeric", 232)))

names(data) <- toupper(iconv(names(data), to="ASCII//TRANSLIT"))
```

# Seleção dos registros de 2010
```{r}
data <- filter(data, ANO=="2010")
```

# Seleção das variáveis

## Remoção das variáveis irrelevantes
```{r}
data <- select(data, -c("ANO", "UF", "CODMUN6", "CODMUN7", "MUNICIPIO"))
```

## Variáveis altamente correlacionadas
```{r}
correlationMatrix <- cor(data)
highlyCorrelated <- findCorrelation(correlationMatrix, cutoff=0.8, names=TRUE)
paste(highlyCorrelated, collapse = ", ")
#dicionario %>% filter(SIGLA %in% highlyCorrelated) %>% select(CATEGORIA, SIGLA, NOME.CURTO)
```

## Importância da variáveis estimada por modelo
```{r}
set.seed(1)
control <- trainControl(method="repeatedcv", number=10, repeats=3)
control <- trainControl(method="none")
model <- train(ESPVIDA ~ ., data=data, method="svmRadial", preProcess="scale", trControl=control)
importance <- varImp(model, scale=FALSE)
print(importance)
plot(importance)
```

## Remoção das variáveis redundantes com base na [análise exploratória](https://mauriciocramos.github.io/IDHM/IDHM-EDA.html).

Remoção das variáveis redundantes dentro de cada categoria
```{r}
#TODO
```

# Pré-processamento das variáveis

## Normalização dos valores
```{r}
#TODO
```

## Análise de Componentes Principais
```{r}
#TODO
```

# Particionamento dos dados de treino e teste

```{r}
#TODO: https://topepo.github.io/caret/subsampling-for-class-imbalances.html
#TODO: https://topepo.github.io/caret/data-splitting.html#splitting-based-on-the-predictors
#TODO: https://topepo.github.io/caret/data-splitting.html#simple-splitting-with-important-groups

set.seed(1)
inTraining <- createDataPartition(data$ESPVIDA, p = .60, list = FALSE)
training <- data[ inTraining,]
testing  <- data[-inTraining,]
```

# Seleção de algoritmos e hiperparâmetros
```{r}
cluster <- makeCluster(detectCores())
registerDoParallel(cluster)
```

## 1 - Random Forest sem reamostragem
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, trControl = trainControl(method = "none", verboseIter=TRUE))
proc.time() - ptm #note 43s icict 28s
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 2 - Random Forest com reamostragem em validação cruzada de 2 folds
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="cv", number=2, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm #note 748s icict 419s
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 3 - Random Forest com reamostragem em validação cruzada de 5 folds
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="cv", number=5, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 4 - Random Forest com reamostragem em validação cruzada de 10 folds
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="cv", number=10, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 5 - Random Forest com reamostragem em bootstrap de 2 iterações
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="boot", number=2, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 6 - Random Forest com reamostragem em bootstrap de 5 iterações
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="boot", number=5, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 7 - Random Forest com reamostragem em bootstrap de 10 iterações
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="boot", number=10, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 8 - Random Forest com reamostragem em bootstrap de 20 iterações
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="boot", number=20, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 9 - Random Forest com reamostragem em bootstrap de 25 iterações
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="boot", number=25, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

```{r}
stopCluster(cluster)
registerDoSEQ()
```

```{r, echo=FALSE}
date()
proc.time() - t0
```