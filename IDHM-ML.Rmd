---
title: "Análise preditiva da expectativa de vida no Brasil"
author: "Maurício Collaça Ramos"
date: "12 de Julho de 2018"
output: 
  html_document: 
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float:
        collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "")
options(width = 130)
t0 <- proc.time()
```

# Recursos computacionais

Sistema Operacional:
```{r}
paste(Sys.info()[1:3], collapse = " ")
```

Processadores:
```{r}
parallel::detectCores()
```

Memória:
```{r}
if(Sys.info()[1]=="Windows") paste(round(memory.limit()/1024,1),"Gb") else cat(system("free -h", intern = TRUE), sep='\n')
```

Linguagem:
```{r}
R.version.string
```

Pacotes R:
```{r}
packages <- c("caret", "parallel", "doParallel", "randomForest", "e1071", "xgboost", "gbm")
loaded <- sapply(packages, require, character.only=TRUE, warn.conflicts=TRUE, quietly=FALSE)
if(!all(loaded)) {
    missingPackages <- packages[loaded==FALSE]
    message("Installing package(s) ", paste(missingPackages, collapse=", "))
    install.packages(missingPackages, dependencies = TRUE)
    installed <- sapply(missingPackages, require, character.only=TRUE, warn.conflicts=TRUE, quietly=FALSE)
    if(!all(installed)) stop("Package(s) not installed: ", paste(missingPackages[installed==FALSE], collapse=", "))
    
}
packageVersions <- sapply(packages, function(x) paste0(as.character(packageVersion(x)), collapse="."))
noquote(packageVersions)
```

# Habilitando processamento paralelo
```{r}
cluster <- makeCluster(detectCores())
registerDoParallel(cluster)
if(Sys.info()[1]=="Linux") noquote(system("ps -aufx | grep -e maurici+", intern=TRUE))
```

# Carga dos dados brutos do atlas municipal de 2010
```{r}
data <- read.csv2("municipal.csv", encoding = "UTF-8",
                  colClasses=c(rep("factor",2),rep("character",3),rep("numeric", 232)))
names(data) <- toupper(iconv(names(data), to="ASCII//TRANSLIT"))
data <- data[data$ANO=="2010",]
```

# Seleção das variáveis

Remoção das variáveis identificadoras das observações, assumidas como irrelevantes para o modelo preditivo.
```{r}
data <- subset(data, select = -c(ANO, UF, CODMUN6, CODMUN7, MUNICIPIO))
```
Remoção das variáveis dependentes da variável alvo `ESPVIDA` (expectativa de vida ao nascer) pois seriam um vazamento de dados no modelo preditivo.

$$IDHM\_L = \frac{ESPVIDA - 25}{60}$$
$$IDHM = \sqrt[3]{IDHM\_E * IDHM\_L * IDHM\_R}$$
```{r}
data <- subset(data, select = -c(IDHM, IDHM_L))
```

# Teste de multiplos modelos

```{r}
if(!file.exists("models.RDS")) {
    models <- expand.grid(
        method = list("glm", "svmLinear2", "knn", "rf", "rpart", "gbm", "xgbTree"),
        partition = list(.1, .2, .3, .4, .5, .6, .7, .8, .9),
        preProcess = list(null = NULL,
                          center = "center",
                          scale = "scale",
                          pca = "pca",
                          center_scale = c("center", "scale"),
                          center_pca = c("center", "pca"),
                          scale_pca = c("scale", "pca"),
                          center_scale_pca = c("center", "scale", "pca")),
        time = list(NA),
        performance = list(NA))
    models <- as.list(as.data.frame(t(models), optional = TRUE))
} else  models <- readRDS("models.RDS")
```
```{r}
for(i in seq(models)) {
    if(all(!is.na(models[[i]]$time) & any(!is.na(models[[i]]$performance)))) next
    with(models[[i]], message("\n[",Sys.time(),"]",
                              " #",i,"/",length(models),
                              " training:",
                              " method=", method,
                              " %rows=", partition,
                              " preProc=", paste(preProcess, collapse="+")))
    set.seed(1)
    inTraining <- createDataPartition(data$ESPVIDA, p = models[[i]]$partition, list = FALSE)
    time <- proc.time()
    fit <- train(ESPVIDA ~ ., data[inTraining, ],
                 #importance=NULL, #rf
                 #verbose=FALSE, #gbm
                 method = models[[i]]$method,
                 preProcess = models[[i]]$preProcess,
                 trControl = trainControl(method = "cv", number = 2, search = "grid"))
    models[[i]]$time <- proc.time() - time
    models[[i]]$performance <- postResample(predict(fit, data[-inTraining, ]),
                                            data$ESPVIDA[-inTraining])
    with(models[[i]], message("\n\tRMSE=", performance[[1]], " elapsed=", time[3]))
    rm(fit); rm(time); rm(inTraining)
    saveRDS(models, "models.RDS")
}
```
```{r}
(summary <- Reduce(rbind, lapply(models, function(x) {
    data.frame(method=x$method,
               partition=x$partition,
               preProcess=paste(x$preProcess, collapse=","),
               RMSE=x$performance[[1]],
               elapsed=x$time[[3]],stringsAsFactors = FALSE)
})))
```

<!-- # Particionamento dos dados de treino e teste -->
<!-- ```{r} -->
<!-- #TODO: https://topepo.github.io/caret/subsampling-for-class-imbalances.html -->
<!-- #TODO: https://topepo.github.io/caret/data-splitting.html#splitting-based-on-the-predictors -->
<!-- #TODO: https://topepo.github.io/caret/data-splitting.html#simple-splitting-with-important-groups -->

<!-- set.seed(1) -->
<!-- inTraining <- createDataPartition(data$ESPVIDA, p = .1, list = FALSE) -->
<!-- training <- data[ inTraining,] -->
<!-- testing  <- data[-inTraining,] -->
<!-- ``` -->

<!-- ## Random Forest com reamostragem em validação cruzada de 5 folds -->
<!-- ```{r, cache=TRUE} -->
<!-- set.seed(1) -->
<!-- t1 <- proc.time() -->

<!-- fit <- train(ESPVIDA ~ ., training, method="rf", -->
<!--              # trControl=trainControl(method="cv", number=5, search="grid")) -->
<!--              trControl=trainControl(method = "none")) -->
<!-- proc.time() - t1 -->
<!-- fit -->
<!-- postResample(predict(fit, testing), testing$ESPVIDA) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- importance <- varImp(fit, scale=FALSE) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- plot(importance, top=20) -->
<!-- ``` -->

# Desabilitando processamento paralelo
```{r}
stopCluster(cluster)
registerDoSEQ()
if(Sys.info()[1]=="Linux") noquote(system("ps -auxf | grep -e maurici+", intern=TRUE))
```

```{r, echo=FALSE}
date()
proc.time() - t0
```