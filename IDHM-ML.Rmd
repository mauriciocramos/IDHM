---
title: "Análise preditiva da expectativa de vida no Brasil"
author: "Maurício Collaça Ramos"
date: "12 de Julho de 2018"
output: 
  html_document: 
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float:
        collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "")
options(width = 130)
t0<-proc.time()
```

# Recursos computacionais

Sistema Operacional:
```{r}
paste(Sys.info()[1:3], collapse = " ")
```

Processadores:
```{r}
parallel::detectCores()
```

Memória:
```{r}
if(Sys.info()[1]=="Windows") paste(round(memory.limit()/1024,1),"Gb") else cat(system("free -h", intern = TRUE), sep='\n')
```

Linguagem:
```{r}
R.version.string
```

Pacotes R:
```{r}
packages <- c("plyr", "ggplot2", "gridExtra", "GGally", "dplyr", "tidyr", "caret", "parallel", "doParallel", "randomForest")
loaded <- suppressMessages(suppressWarnings(sapply(packages, require, character.only=TRUE, warn.conflicts=FALSE, quietly=TRUE)))
if(!all(loaded)) {
    missingPackages <- packages[loaded==FALSE]
    message("Installing package(s) ", paste(missingPackages, collapse=", "))
    install.packages(missingPackages, dependencies = TRUE)
    installed <- suppressWarnings(sapply(missingPackages, require, character.only=TRUE, warn.conflicts=FALSE, quietly=TRUE))
    if(!all(installed)) stop("Package(s) not installed: ", paste(missingPackages[installed==FALSE], collapse=", "))
    
}
packageVersions <- sapply(packages, function(x) paste0(as.character(packageVersion(x)), collapse="."))
noquote(packageVersions)
```

# Carga dos dados brutos do atlas municipal

```{r}
dicionario <- read.csv2("dicionario.csv", encoding = "UTF-8")
names(dicionario) <- toupper(iconv(names(dicionario), to="ASCII//TRANSLIT"))
data <- read.csv2("municipal.csv", encoding = "UTF-8",
                       colClasses=c(rep("factor",2),rep("character",3),rep("numeric", 232)))

names(data) <- toupper(iconv(names(data), to="ASCII//TRANSLIT"))
```

# Seleção dos registros de 2010
```{r}
data <- filter(data, ANO=="2010")
```

# Habilitando processamento paralelo
```{r}
cluster <- makeCluster(detectCores())
registerDoParallel(cluster)
```

# Seleção das variáveis

## Remoção das variáveis assumidas como irrelevantes
```{r}
data <- select(data, -c("ANO", "UF", "CODMUN6", "CODMUN7", "MUNICIPIO"))
```

## Variáveis altamente correlacionadas

Proposta de preditores que não estejam altamente correlacionados dentro dos seus grupos.
94 preditores:
FECTOT, MORT1, RAZDEP, SOBRE40, T_ENV, E_ANOSESTUDO, T_ANALF15A17, T_ANALF25M, T_FUND12A14, T_FUND15A17, T_MED25M, T_ATRASO_1_BASICO, T_ATRASO_1_MED, T_ATRASO_2_MED, T_FREQ0A3, T_FREQ11A14, T_FREQ15A17, T_FREQ18A24, T_FREQ25A29, T_FREQ4A5, T_FREQ6, T_FBBAS, T_FBMED, T_FBSUPER, T_FLBAS, T_FLFUND, T_FLMED, T_FLPRE, T_FREQFUND1517, T_FREQFUND1824, T_FREQFUND45, T_FREQMED1824, T_FREQMED614, T_FREQSUPER1517, T_AGUA, T_DENS, T_LIXO, AGUA_ESGOTO, PAREDE, T_SLUZ, PREN10RICOS, PRENTRAB, R1040, RDPC, RIND, RMPOB, THEILTRAB, GINI, PPOB, CPR, EMP, P_AGRO, P_COM, P_CONSTR, P_EXTR, P_FORMAL, P_SERV, P_SIUP, P_SUPER, P_TRANSF, REN0, REN5, TRABPUB, TRABSC, HOMEM5A9, MULH5A9, PEA1014, PESORUR, T_ATIV1014, T_ATIV1517, T_ATIV2529, T_DES1014, T_DES1517, T_DES1824, T_DES2529, T_FORA4A5, T_FORA6A14, T_FUNDIN18MINF, T_M10A14CF, T_M15A17CF, T_MULCHEFEFIF014, T_OCUPDESLOC_1, T_RMAXIDOSO, T_FREQ5A6, T_FUND11A13, T_FUND18M

Proposta de preditores que não estejam altamente correlacionados entre seus grupos.
72 preditores:
FECTOT, MORT1, RAZDEP, SOBRE40, T_ENV, E_ANOSESTUDO, T_ANALF15A17, T_FUND12A14, T_ATRASO_1_BASICO, T_ATRASO_1_MED, T_ATRASO_2_MED, T_FREQ0A3, T_FREQ11A14, T_FREQ15A17, T_FREQ18A24, T_FREQ25A29, T_FREQ6, T_FBBAS, T_FBMED, T_FBSUPER, T_FLBAS, T_FLFUND, T_FLMED, T_FLPRE, T_FREQFUND1517, T_FREQFUND1824, T_FREQFUND45, T_FREQMED1824, T_FREQMED614, T_FREQSUPER1517, T_AGUA, T_DENS, T_LIXO, AGUA_ESGOTO, PAREDE, T_SLUZ, PREN10RICOS, PRENTRAB, R1040, RIND, RMPOB, THEILTRAB, CPR, EMP, P_AGRO, P_COM, P_CONSTR, P_EXTR, P_FORMAL, P_SERV, P_SIUP, P_SUPER, P_TRANSF, REN0, REN5, TRABPUB, TRABSC, HOMEM5A9, PESORUR, T_ATIV1014, T_ATIV1517, T_ATIV2529, T_DES1014, T_DES1517, T_DES1824, T_DES2529, T_M10A14CF, T_M15A17CF, T_MULCHEFEFIF014, T_OCUPDESLOC_1, T_RMAXIDOSO, T_FREQ5A6

Proposta de preditores que não estejam altamente correlacionados em geral.
68 preditores:
FECTOT, MORT5, SOBRE40, T_ENV, E_ANOSESTUDO, T_ANALF15A17, T_ATRASO_1_BASICO, T_ATRASO_1_MED, T_ATRASO_2_MED, T_FBBAS, T_FBMED, T_FBPRE, T_FLBAS, T_FLFUND, T_FLMED, T_FLSUPER, T_FREQ0A3, T_FREQ15A17, T_FREQ18A24, T_FREQ25A29, T_FREQ6, T_FREQFUND1517, T_FREQFUND1824, T_FREQFUND45, T_FREQMED1824, T_FREQMED614, T_FREQSUPER1517, T_FUND12A14, PREN10RICOS, PRENTRAB, R1040, RIND, RMPOB, CPR, EMP, P_AGRO, P_COM, P_CONSTR, P_EXTR, P_SERV, P_SIUP, P_SUPER, P_TRANSF, REN0, T_ATIV1014, T_ATIV1517, T_ATIV18M, T_DES1014, T_DES1517, T_DES1824, THEILTRAB, TRABCC, TRABPUB, TRABSC, T_AGUA, T_DENS, T_LIXO, AGUA_ESGOTO, PAREDE, T_FORA4A5, T_M10A14CF, T_M15A17CF, T_MULCHEFEFIF014, T_OCUPDESLOC_1, T_RMAXIDOSO, T_SLUZ, PEA1014, PESORUR

```{r}
correlationMatrix <- cor(data)
highlyCorrelated <- findCorrelation(correlationMatrix, cutoff=0.8, names=TRUE)
paste(highlyCorrelated, collapse = ", ")
#dicionario %>% filter(SIGLA %in% highlyCorrelated) %>% select(CATEGORIA, SIGLA, NOME.CURTO)
```

## Importância das variáveis estimada por modelo Random Forest
```{r}
set.seed(1)
# control <- trainControl(method="cv", number=10, verboseIter=TRUE)
control <- trainControl(method="cv", number=2, verboseIter=TRUE)
# control <- trainControl(method="none", verboseIter=TRUE)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., data=data, method="rf", preProcess="scale", trControl=control, importance=TRUE)
proc.time() - ptm
fit
``` 
```{r}
ptm <- proc.time()
importance <- varImp(fit, scale=FALSE)
proc.time() - ptm
importance
```
```{r}
plot(importance, top=20)
```

## Recursive Feature Elimination (RFE)
```{r}
library(doMC)
registerDoMC(cores = parallel::detectCores())
set.seed(1)
control <- rfeControl(functions=rfFuncs, method="cv", number=10)
ptm <- proc.time()
# results <- rfe(data[,-1], data[,1], sizes=c(1:8), rfeControl=control)
results <- rfe(data[,-1], data[,1], sizes=2^(2:4), rfeControl=control)
proc.time() - ptm
results
```

```{r}
predictors(results)
```

```{r}
plot(results, type=c("g", "o"))
```

## Remoção das variáveis redundantes com base na [análise exploratória](https://mauriciocramos.github.io/IDHM/IDHM-EDA.html).

Remoção das variáveis redundantes dentro de cada categoria
```{r}
#TODO
```

# Pré-processamento das variáveis

## Normalização dos valores
```{r}
#TODO
```

## Análise de Componentes Principais
```{r}
#TODO
```

# Particionamento dos dados de treino e teste

```{r}
#TODO: https://topepo.github.io/caret/subsampling-for-class-imbalances.html
#TODO: https://topepo.github.io/caret/data-splitting.html#splitting-based-on-the-predictors
#TODO: https://topepo.github.io/caret/data-splitting.html#simple-splitting-with-important-groups

set.seed(1)
inTraining <- createDataPartition(data$ESPVIDA, p = .60, list = FALSE)
training <- data[ inTraining,]
testing  <- data[-inTraining,]
```

# Seleção de algoritmos e hiperparâmetros

## 1 - Random Forest sem reamostragem
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, trControl = trainControl(method = "none", verboseIter=TRUE))
proc.time() - ptm #note 43s icict 28s
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 2 - Random Forest com reamostragem em validação cruzada de 2 folds
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="cv", number=2, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm #note 748s icict 419s
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 3 - Random Forest com reamostragem em validação cruzada de 5 folds
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="cv", number=5, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 4 - Random Forest com reamostragem em validação cruzada de 10 folds
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="cv", number=10, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 5 - Random Forest com reamostragem em bootstrap de 2 iterações
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="boot", number=2, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 6 - Random Forest com reamostragem em bootstrap de 5 iterações
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="boot", number=5, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 7 - Random Forest com reamostragem em bootstrap de 10 iterações
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="boot", number=10, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 8 - Random Forest com reamostragem em bootstrap de 20 iterações
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="boot", number=20, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

## 9 - Random Forest com reamostragem em bootstrap de 25 iterações
```{r, cache=TRUE}
set.seed(1)
ptm <- proc.time()
fit <- train(ESPVIDA ~ ., training, method="rf", preProcess=NULL, trControl=trainControl(method="boot", number=25, search="grid", verboseIter=TRUE), tuneGrid=NULL, tuneLength=3)
proc.time() - ptm
fit
postResample(predict(fit, testing), testing$ESPVIDA)
```

# Desabilitando processamento paralelo
```{r}
stopCluster(cluster)
registerDoSEQ()
```

```{r, echo=FALSE}
date()
proc.time() - t0
```